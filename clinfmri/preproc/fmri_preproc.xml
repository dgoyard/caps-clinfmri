<pipeline>
    <docstring>
        FMRI spatial preunitings.

        Steps:
            * Reorientation
            * Slice registration
            * Slice timing
            * Realignement
            * Coregistration
            * Normalization
            * Smoothing
            * BET
    </docstring>
    <units>
        <unit name="reorientfunc">
            <module>clinfmri.utils.image_reorientation.xml</module>
        </unit>
        <unit name="reorientstruct">
            <module>clinfmri.utils.image_reorientation.xml</module>
        </unit>
        <unit name="register">
            <module>clinfmri.utils.itk_slice_registration.xml</module>
        </unit>
        <unit name="slicer">
            <module>clinfmri.preproc.slice_timing.xml</module>
        </unit>
        <unit name="realign">
            <module>clinfmri.preproc.spm_realignement.xml</module>
        </unit>
        <unit name="coregister">
            <module>clinfmri.preproc.spm_coregistration.xml</module>
        </unit>
        <unit name="normalize">
            <module>clinfmri.preproc.spm_normalization.xml</module>
        </unit>
        <unit name="smoothing">
            <module>clinfmri.utils.spm_smoothing.xml</module>
        </unit>
        <unit name="bet">
            <module>clinfmri.utils.fsl_bet.xml</module>
            <set name="use_4d_input" value="True"/>
        </unit>
    </units>
    <links>
        <link source="reorientfunc.reoriented_file" destination="register.input_file"/>
        <link source="reorientstruct.reoriented_file" destination="coregister.moving_image"/>
        <link source="reorient_axes" destination="reorientstruct.axes"/>
        <link source="do_reorientation" destination="reorientstruct.do_reorientation"/>
        <link source="register.registered_file" destination="slicer.fmri_file"/>
        <link source="slicer.time_corrected_fmri_file" destination="realign.fmri_file"/>
        <link source="realign.reference_mean_file" destination="coregister.reference_image"/>
        <link source="realign.realigned_fmri_header_modified_file" destination="normalize.fmri_file"/>
        <link source="coregister.coregistered_fmri_file" destination="normalize.coregistered_struct_file"/>
        <link source="normalize.normalized_fmri_file" destination="smoothing.image_file"/>
        <!-- INPUTS -->
        <input source="do_reorientation" destination="reorientfunc.do_reorientation"/>
        <input source="reorient_axes" destination="reorientfunc.axes"/>
        <input source="fmri_file" destination="reorientfunc.input_file"/>
        <input source="structural_file" destination="reorientstruct.input_file"/>
        <input source="coreg_fwhm" destination="coregister.fwhm"/>
        <input source="realign_register_to_mean" destination="realign.register_to_mean"/>
        <input source="mvt_thr" destination="realign.mvt_thr"/>
        <input source="rot_thr" destination="realign.rot_thr"/>
        <input source="norm_struct_voxel_sizes" destination="normalize.struct_voxel_sizes"/>
        <input source="norm_func_voxel_sizes" destination="normalize.func_voxel_sizes"/>
        <input source="template_file" destination="normalize.template_file"/>
        <!-- <input name="smooth_fwhm" destination="smoothing.fwhm"/> -->
        <input source="bet_generate_binary_mask" destination="bet.generate_binary_mask"/>
        <input source="bet_generate_skull" destination="bet.generate_skull"/>
        <input source="bet_generate_mesh" destination="bet.generate_mesh"/>
        <input source="bet_threshold" destination="bet.bet_threshold"/>
        <!-- OUTPUTS -->
        <output source="bet.bet_out_file" destination="bet_out_file"/>
        <output source="realign.snap_mvt" destination="qc_snap_mvt"/>
        <output source="realign.displacement_file" destination="qc_displacement_file"/>
        <output source="normalize.qc_edges_file" optional="True" destination="qc_edges_file"/>
    </links>
    <positions>
        <position unit="inputs" x="-1072" y="281"/>
        <position unit="reorientfunc" x="-802" y="35"/>
        <position unit="reorientstruct" x="-456" y="807"/>
        <position unit="register" x="-622" y="85"/>
        <position unit="slicer" x="-453" y="227"/>
        <position unit="realign" x="-226" y="575"/>
        <position unit="coregister" x="-164" y="47"/>
        <position unit="normalize" x="-125" y="254"/>
        <position unit="bet" x="148" y="815"/>
        <position unit="smoothing" x="220" y="620"/>
        <position unit="outputs" x="618" y="371"/>
    </positions>
    <scale factor="0.6"/> 
</pipeline>
